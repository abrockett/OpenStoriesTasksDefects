<!DOCTYPE html>
<html>
<head>
    <title>OpenStoriesTasksDefects</title>

    <script type="text/javascript" src="/apps/2.0rc1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("Rally.apps.openstoriestasksdefects.App",{extend:"Rally.app.TimeboxScopedApp",componentCls:"app",scopeType:"iteration",comboboxConfig:{fieldLabel:"Select Iteration:",labelWidth:100,width:300},addContent:function(){this.add({xtype:"container",itemId:"userNameHeader",componentCls:"mainHeader"},{xtype:"container",itemId:"storyComps",items:[{xtype:"displayfield",itemId:"story-title",value:'<p style="font-size:13px">No Stories in Iteration</p><br />',componentCls:"gridTitle"}]},{xtype:"container",itemId:"defectComps",items:[{xtype:"displayfield",itemId:"defect-title",value:'<p style="font-size:13px">No Defects in Iteration</p><br />',componentCls:"gridTitle"}]},{xtype:"container",itemId:"taskComps",items:[{xtype:"displayfield",itemId:"task-title",value:'<p style="font-size:13px">No Tasks in Iteration</p><br />',componentCls:"gridTitle"}]}),this._query()},onScopeChange:function(){this._query()},_ownerIfKnown:function(artifact){var name="unknown";return null===artifact?name="-":artifact._refObjectName&&artifact.DisplayName?name=artifact.DisplayName:artifact._refObjectName&&artifact.UserName?name=artifact.UserName:artifact._refObjectName&&(name=artifact._refObjectName),name},_query:function(){var username=this.getContext().getUser().UserName;this.down("#userNameHeader").update("<h3>Open Items for "+username+":</h3>"),Ext.create("Rally.data.WsapiDataStore",{model:"UserStory",autoLoad:!0,fetch:["ObjectID","FormattedID","Name","ScheduleState","State","Owner","UserName","DisplayName","Tasks","Defects","TestCases","LastVerdict"],filters:[this.getContext().getTimeboxScope().getQueryFilter(),{property:"Owner.UserName",operator:"=",value:username},{property:"ScheduleState",operator:"!=",value:"Completed"},{property:"ScheduleState",operator:"!=",value:"Accepted"}],sorters:[{property:"FormattedID",direction:"ASC"}],listeners:{load:this._onStoriesDataLoaded,scope:this}}),Ext.create("Rally.data.WsapiDataStore",{model:"Task",autoLoad:!0,fetch:["ObjectID","FormattedID","Name","Owner","UserName","DisplayName","State"],filters:[this.getContext().getTimeboxScope().getQueryFilter(),{property:"Owner.UserName",operator:"=",value:username},{property:"State",operator:"!=",value:"Completed"}],sorters:[{property:"FormattedID",direction:"ASC"}],listeners:{load:this._onTasksDataLoaded,scope:this}}),Ext.create("Rally.data.WsapiDataStore",{model:"Defect",autoLoad:!0,fetch:["ObjectID","FormattedID","Name","Owner","UserName","DisplayName","ScheduleState","Tasks","State"],filters:[this.getContext().getTimeboxScope().getQueryFilter(),{property:"Owner.UserName",operator:"=",value:username},{property:"ScheduleState",operator:"!=",value:"Completed"},{property:"ScheduleState",operator:"!=",value:"Accepted"}],sorters:[{property:"FormattedID",direction:"ASC"}],listeners:{load:this._onDefectsDataLoaded,scope:this}})},_onStoriesDataLoaded:function(store,data){this._storyRecords=[];var taskList=[],numberTimesLoaded=data.length;0===data.length&&this._onStoriesInfoLoaded([],0),Ext.Array.each(data,function(story,index){this._storyRecords.push({FormattedID:story.get("FormattedID"),Name:'<div class="parent"><a href="'+Rally.nav.Manager.getDetailUrl(story.get("_ref"))+'" target="_top">'+story.get("FormattedID")+" "+story.get("Name")+"</a></div>",Status:'<div class="parent">'+story.get("ScheduleState")+"</div>",UserName:'<div class="parent">'+this._ownerIfKnown(story.get("Owner"))+"</div>"}),story.getCollection("Tasks").load({fetch:["FormattedID","Name","State","Owner","UserName","DisplayName"],scope:this,callback:function(tasks,operation,success){taskList=taskList.concat(this._getTasks(tasks,story)),index+1===numberTimesLoaded&&this._onStoriesInfoLoaded(taskList,data.length)}})},this)},_onStoriesInfoLoaded:function(tasks,dataLength){var data=[];this._storyRecords&&(data=Ext.clone(this._storyRecords));var formattedData=this._formatTasks(tasks,data);this._onStoriesDataReady(formattedData,dataLength)},_onTasksDataLoaded:function(store,data){var records=Ext.Array.map(data,function(task){return{Name:'<div class="task"><a href="'+Rally.nav.Manager.getDetailUrl(task.get("_ref"))+'" target="_top">'+task.get("FormattedID")+" "+task.get("Name")+"</a></div>",Status:'<div class="task">'+task.get("State")+"</div>",UserName:'<div class="task">'+this._ownerIfKnown(task.get("Owner"))+"</div>"}},this);this._onTasksDataReady(records,data.length)},_formatTasks:function(tasks,data){for(var taskID,tempTaskList=[],i=0;tasks.length>i;i++){taskID=tasks[i].matchedFormattedID;for(var j=i;tasks.length>j;j++)tasks[j].matchedFormattedID===taskID&&(Ext.Array.insert(tempTaskList,j+1,[tasks[j]]),i++);for(var r=0;data.length>r;r++)if(data[r].FormattedID===taskID){Ext.Array.insert(data,r+1,tempTaskList);break}tempTaskList=[],i--}return data},_onDefectsInfoLoaded:function(tasks,dataLength){var data=[];this._defectRecords&&(data=Ext.clone(this._defectRecords));var formattedData=this._formatTasks(tasks,data);this._onDefectsDataReady(formattedData,dataLength)},_onDefectsDataLoaded:function(store,data){var taskList=[];this._defectRecords=[],numberTimesLoaded=data.length,0===data.length&&this._onDefectsInfoLoaded([],0),Ext.Array.each(data,function(defect,index){this._defectRecords.push({FormattedID:defect.get("FormattedID"),Name:'<div class="parent"><a href="'+Rally.nav.Manager.getDetailUrl(defect.get("_ref"))+'" target="_top">'+defect.get("FormattedID")+" "+defect.get("Name")+"</a></div>",Status:'<div class="parent">'+defect.get("ScheduleState")+"</div>",UserName:'<div class="parent">'+this._ownerIfKnown(defect.get("Owner"))+"</div>"}),defect.getCollection("Tasks").load({fetch:["FormattedID","Name","State","Owner","UserName","DisplayName"],scope:this,callback:function(tasks,operation,success){taskList=taskList.concat(this._getTasks(tasks,defect)),index+1===numberTimesLoaded&&this._onDefectsInfoLoaded(taskList,data.length)}})},this)},_getTasks:function(tasks,defect){for(var taskList=[],i=0;tasks.length>i;i++)"Completed"!==tasks[i].get("State")&&taskList.push({matchedFormattedID:defect.get("FormattedID"),Name:'<div class="child"><a href="'+Rally.nav.Manager.getDetailUrl(tasks[i].raw._ref)+'" target="_top">'+tasks[i].raw.FormattedID+" "+tasks[i].raw.Name+"</a></div>",Status:"<div>"+tasks[i].raw.State+"</div>",UserName:"<div>"+this._ownerIfKnown(tasks[i].raw.Owner)+"</div>",FormattedID:tasks[i].get("FormattedID")});return taskList},_onStoriesDataReady:function(data,dataLength){var hide=!1,storyTitle;0===data.length?(storyTitle="No Stories In Iteration",hide=!0):storyTitle="Stories: "+dataLength,this.down("#story-title").update(storyTitle);var customStore=this._createCustomStore(data,hide);this.storyGrid?(this.storyGrid.reconfigure(customStore),0===data.length?this.storyGrid.setVisible(!1):this.storyGrid.setVisible(!0)):this.storyGrid=this._createCustomGrid(customStore,hide,"#storyComps")},_onDefectsDataReady:function(data,dataLength){var hide=!1,defectTitle;0===data.length?(defectTitle="No Defects In Iteration",hide=!0):defectTitle="Defects: "+dataLength,this.down("#defect-title").update(defectTitle);var customStore=this._createCustomStore(data,hide);this.defectGrid?(this.defectGrid.reconfigure(customStore),0===data.length?this.defectGrid.setVisible(!1):this.defectGrid.setVisible(!0)):this.defectGrid=this._createCustomGrid(customStore,hide,"#defectComps")},_onTasksDataReady:function(data,dataLength){var hide=!1,taskTitle;0===dataLength?(taskTitle="No Tasks In Iteration",hide=!0):taskTitle="Tasks: "+dataLength,this.down("#task-title").update(taskTitle);var customStore=this._createCustomStore(data,hide);this.taskGrid?(this.taskGrid.reconfigure(customStore),0===data.length?this.taskGrid.setVisible(!1):this.taskGrid.setVisible(!0)):this.taskGrid=this._createCustomGrid(customStore,hide,"#taskComps")},_createCustomField:function(container,title){return field=this.down(container).add({xtype:"displayfield",value:'<p style="font-size:13px">'+title+"</p><br />",componentCls:"gridTitle"})},_createCustomGrid:function(store,hide,container){return grid=this.down(container).add({xtype:"rallygrid",store:store,hidden:hide,sortableColumns:!1,columnCfgs:[{text:"Task",dataIndex:"Name",cls:"columnHeader",flex:4},{text:"Status",dataIndex:"Status",cls:"columnHeader",flex:1},{text:"Owner",dataIndex:"UserName",cls:"columnHeader",flex:1}]})},_createCustomStore:function(data,hide){return store=Ext.create("Rally.data.custom.Store",{hidden:hide,data:data,pageSize:data.length})},getOptions:function(){return[{text:"Print",handler:this._onButtonPressed,scope:this}]},_onButtonPressed:function(){var title=this.getContext().getTimeboxScope().getRecord().get("Name"),options,css=document.getElementsByTagName("style")[0].innerHTML;options="toolbar=1,menubar=1,scrollbars=yes,scrolling=yes,resizable=yes,width=1000,height=500";var printWindow;printWindow=Ext.isIE?window.open():window.open("","",options);var doc=printWindow.document,username=this.down("#userNameHeader"),stories=this.down("#storyComps"),defects=this.down("#defectComps"),tasks=this.down("#taskComps");doc.write("<html><head><style>"+css+"</style><title>"+title+"</title>"),doc.write('</head><body class="landscape">'),doc.write('<p style="font-family:Arial,Helvetica,sans-serif;margin:5px">Iteration: '+title+"</p><br />"),doc.write(username.getEl().dom.innerHTML+stories.getEl().dom.innerHTML+defects.getEl().dom.innerHTML+tasks.getEl().dom.innerHTML),doc.write("</body></html>"),doc.close(),this._injectCSS(printWindow),printWindow.print()},_injectContent:function(html,elementType,attributes,container,printWindow){elementType=elementType||"div",container=container||printWindow.document.getElementsByTagName("body")[0];var element=printWindow.document.createElement(elementType);return Ext.Object.each(attributes,function(key,value){"class"===key?element.className=value:element.setAttribute(key,value)}),html&&(element.innerHTML=html),container.appendChild(element)},_injectCSS:function(printWindow){Ext.each(Ext.query("link"),function(stylesheet){this._injectContent("","link",{rel:"stylesheet",href:stylesheet.href,type:"text/css"},printWindow.document.getElementsByTagName("head")[0],printWindow)},this)}});

            Rally.launchApp('Rally.apps.openstoriestasksdefects.App', {
                name:"OpenStoriesTasksDefects",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .app {
     margin:5px;
}
.combobox {
    margin: 5px;
}
.mainHeader {
    margin: 10px 5px 0px;
}
.gridTitle {
    margin: 25px 17px 5px;
    font-size: 13px;
}
.grid {
    margin:5px;
}
.columnHeader {
    font-size:1.125em;
}
.parent {
    font-weight:bold;
    line-height:120%;
}
.child {
    margin-left:20px;
    line-height:120%;
}

    </style>
</head>
<body></body>
</html>
