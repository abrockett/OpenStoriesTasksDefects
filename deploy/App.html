<!DOCTYPE html>
<html>
<head>
    <title>OpenStoriesTasksDefects</title>

    <script type="text/javascript" src="/apps/2.0rc1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",items:[{xtype:"container",itemId:"iterationCombobox",componentCls:"combobox"},{xtype:"container",itemId:"userNameHeader",componentCls:"mainHeader"},{xtype:"container",itemId:"storyComps"},{xtype:"container",itemId:"defectComps"},{xtype:"container",itemId:"taskComps"}],launch:function(){this.down("#iterationCombobox").add({xtype:"rallyiterationcombobox",itemId:"iterationComboBox",fieldLabel:"Select Iteration: ",width:310,labelWidth:100,labelStyle:"font-weight:bold;",listeners:{change:this._query,ready:this._query,scope:this}})},_ownerIfKnown:function(artifact){var name="unknown";return null===artifact?name="-":artifact._refObjectName&&artifact.DisplayName?name=artifact.DisplayName:artifact._refObjectName&&artifact.UserName?name=artifact.UserName:artifact._refObjectName&&(name=artifact._refObjectName),name},_query:function(){var username=this.getContext().getUser().UserName;this.down("#userNameHeader").update("<h3>Open Items for "+username+":</h3>"),Ext.create("Rally.data.WsapiDataStore",{model:"UserStory",autoLoad:!0,fetch:["ObjectID","FormattedID","Name","ScheduleState","State","Owner","UserName","DisplayName","Tasks","Defects","TestCases","LastVerdict"],filters:[{property:"Iteration.Name",operator:"=",value:this.down("#iterationComboBox").getRawValue()},{property:"Owner.UserName",operator:"=",value:username},{property:"ScheduleState",operator:"!=",value:"Completed"},{property:"ScheduleState",operator:"!=",value:"Accepted"}],sorters:[{property:"FormattedID",direction:"ASC"}],listeners:{load:this._onStoriesDataLoaded,scope:this}}),Ext.create("Rally.data.WsapiDataStore",{model:"Task",autoLoad:!0,fetch:["ObjectID","FormattedID","Name","Owner","UserName","DisplayName","State"],filters:[{property:"Iteration.Name",operator:"=",value:this.down("#iterationComboBox").getRawValue()},{property:"Owner.UserName",operator:"=",value:username},{property:"State",operator:"!=",value:"Completed"}],sorters:[{property:"FormattedID",direction:"ASC"}],listeners:{load:this._onTasksDataLoaded,scope:this}}),Ext.create("Rally.data.WsapiDataStore",{model:"Defect",autoLoad:!0,fetch:["ObjectID","FormattedID","Name","Owner","UserName","DisplayName","ScheduleState","Tasks","State"],filters:[{property:"Iteration.Name",operator:"=",value:this.down("#iterationComboBox").getRawValue()},{property:"Owner.UserName",operator:"=",value:username},{property:"ScheduleState",operator:"!=",value:"Completed"},{property:"ScheduleState",operator:"!=",value:"Accepted"}],sorters:[{property:"FormattedID",direction:"ASC"}],listeners:{load:this._onDefectsDataLoaded,scope:this}})},_onStoriesDataLoaded:function(store,data){var me=this;this._storyRecords=[];var taskList=[];0===data.length&&me._onStoriesInfoLoaded([],0),Ext.Array.each(data,function(story){this._storyRecords.push({FormattedID:story.get("FormattedID"),Name:'<div class="parent"><a href="'+Rally.nav.Manager.getDetailUrl(story.get("_ref"))+'" target="_top">'+story.get("FormattedID")+" "+story.get("Name")+"</a></div>",Status:'<div class="parent">'+story.get("ScheduleState")+"</div>",UserName:'<div class="parent">'+this._ownerIfKnown(story.get("Owner"))+"</div>"}),story.getCollection("Tasks").load({fetch:["FormattedID","Name","State","Owner","UserName","DisplayName"],callback:function(tasks,operation,success){for(var i=0;tasks.length>i;i++)"Completed"!==tasks[i].get("State")&&taskList.push({matchedFormattedID:story.get("FormattedID"),Name:'<div class="child"><a href="'+Rally.nav.Manager.getDetailUrl(tasks[i].raw._ref)+'" target="_top">'+tasks[i].raw.FormattedID+" "+tasks[i].raw.Name+"</a></div>",Status:"<div>"+tasks[i].raw.State+"</div>",UserName:"<div>"+me._ownerIfKnown(tasks[i].raw.Owner)+"</div>",FormattedID:tasks[i].get("FormattedID")});me._onStoriesInfoLoaded(taskList,data.length)}})},this)},_onStoriesInfoLoaded:function(tasks,dataLength){var taskID,data,tempTaskList=[];data=this._storyRecords?Ext.clone(this._storyRecords):[];for(var i=0;tasks.length>i;i++){taskID=tasks[i].matchedFormattedID;for(var j=i;tasks.length>j;j++)tasks[j].matchedFormattedID===taskID&&(Ext.Array.insert(tempTaskList,j+1,[tasks[j]]),i++);for(var r=0;data.length>r;r++)if(data[r].FormattedID===taskID){Ext.Array.insert(data,r+1,tempTaskList);break}tempTaskList=[],i--}this._onStoriesDataReady(data,dataLength)},_onTasksDataLoaded:function(store,data){var records=[];Ext.Array.each(data,function(task){records.push({Name:'<div class="task"><a href="'+Rally.nav.Manager.getDetailUrl(task.get("_ref"))+'" target="_top">'+task.get("FormattedID")+" "+task.get("Name")+"</a></div>",Status:'<div class="task">'+task.get("State")+"</div>",UserName:'<div class="task">'+this._ownerIfKnown(task.get("Owner"))+"</div>"})},this),this._onTasksDataReady(records,data.length)},_onDefectsInfoLoaded:function(tasks,dataLength){var taskID,data,tempTaskList=[];data=this._defectRecords?Ext.clone(this._defectRecords):[];for(var i=0;tasks.length>i;i++){taskID=tasks[i].matchedFormattedID;for(var j=i;tasks.length>j;j++)tasks[j].matchedFormattedID===taskID&&(Ext.Array.insert(tempTaskList,j+1,[tasks[j]]),i++);for(var r=0;data.length>r;r++)if(data[r].FormattedID===taskID){Ext.Array.insert(data,r+1,tempTaskList);break}tempTaskList=[],i--}this._onDefectsDataReady(data,dataLength)},_onDefectsDataLoaded:function(store,data){var me=this,taskList=[];this._defectRecords=[],0===data.length&&me._onDefectsInfoLoaded([],0),Ext.Array.each(data,function(defect){this._defectRecords.push({FormattedID:defect.get("FormattedID"),Name:'<div class="parent"><a href="'+Rally.nav.Manager.getDetailUrl(defect.get("_ref"))+'" target="_top">'+defect.get("FormattedID")+" "+defect.get("Name")+"</a></div>",Status:'<div class="parent">'+defect.get("ScheduleState")+"</div>",UserName:'<div class="parent">'+this._ownerIfKnown(defect.get("Owner"))+"</div>"}),defect.getCollection("Tasks").load({fetch:["FormattedID","Name","State","Owner","UserName","DisplayName"],callback:function(tasks,operation,success){for(var i=0;tasks.length>i;i++)"Completed"!==tasks[i].get("State")&&taskList.push({matchedFormattedID:defect.get("FormattedID"),Name:'<div class="child"><a href="'+Rally.nav.Manager.getDetailUrl(tasks[i].raw._ref)+'" target="_top">'+tasks[i].raw.FormattedID+" "+tasks[i].raw.Name+"</a></div>",Status:"<div>"+tasks[i].raw.State+"</div>",UserName:"<div>"+me._ownerIfKnown(tasks[i].raw.Owner)+"</div>",FormattedID:tasks[i].get("FormattedID")});me._onDefectsInfoLoaded(taskList,data.length)}})},this)},_onStoriesDataReady:function(data,dataLength){var hide=!1,storyTitle;0===data.length?(storyTitle="No Stories In Iteration",hide=!0):storyTitle="Stories: "+dataLength,this.storyField?this.storyField.update(storyTitle):this.storyField=this._createCustomField("#storyComps",storyTitle);var customStore=this._createCustomStore(data,hide);this.storyGrid?(this.storyGrid.reconfigure(customStore),0===data.length?this.storyGrid.setVisible(!1):this.storyGrid.setVisible(!0)):this.storyGrid=this._createCustomGrid(customStore,hide,"#storyComps")},_onDefectsDataReady:function(data,dataLength){var hide=!1,defectTitle;0===data.length?(defectTitle="No Defects In Iteration",hide=!0):defectTitle="Defects: "+dataLength;var customStore=this._createCustomStore(data,hide);this.defectField?this.defectField.update(defectTitle):this.defectField=this._createCustomField("#defectComps",defectTitle),this.defectGrid?(this.defectGrid.reconfigure(customStore),0===data.length?this.defectGrid.setVisible(!1):this.defectGrid.setVisible(!0)):this.defectGrid=this._createCustomGrid(customStore,hide,"#defectComps")},_onTasksDataReady:function(data,dataLength){var hide=!1,taskTitle;0===dataLength?(taskTitle="No Tasks In Iteration",hide=!0):taskTitle="Tasks: "+dataLength;var customStore=this._createCustomStore(data,hide);this.taskField?this.taskField.update(taskTitle):this.taskField=this._createCustomField("#taskComps",taskTitle),this.taskGrid?(this.taskGrid.reconfigure(customStore),0===data.length?this.taskGrid.setVisible(!1):this.taskGrid.setVisible(!0)):this.taskGrid=this._createCustomGrid(customStore,hide,"#taskComps")},_createCustomField:function(container,title){return field=this.down(container).add({xtype:"displayfield",value:'<p style="font-size:13px">'+title+"</p><br />",componentCls:"gridTitle"})},_createCustomGrid:function(store,hide,container){return grid=this.down(container).add({xtype:"rallygrid",store:store,hidden:hide,sortableColumns:!1,showPagingToolbar:!1,columnCfgs:[{text:"Task",dataIndex:"Name",cls:"columnHeader",flex:4},{text:"Status",dataIndex:"Status",cls:"columnHeader",flex:1},{text:"Owner",dataIndex:"UserName",cls:"columnHeader",flex:1}]})},_createCustomStore:function(data,hide){return store=Ext.create("Rally.data.custom.Store",{hidden:hide,data:data,pageSize:data.length})}});

            Rally.launchApp('CustomApp', {
                name:"OpenStoriesTasksDefects",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .app {
     margin:5px;
}
.combobox {
    margin: 5px;
}
.mainHeader {
    margin: 10px 5px 0px;
}
.gridTitle {
    margin: 25px 17px 5px;
    font-size: 13px;
}
.grid {
    margin:5px;
}
.columnHeader {
    font-size:1.125em;
}
.parent {
    font-weight:bold;
    line-height:120%;
}
.child {
    margin-left:20px;
    line-height:120%;
}

    </style>
</head>
<body></body>
</html>
